<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockChain based Service Management</title>
    <style>
         body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom right, #e4f65b, #02ff0f);
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <h1><u>Welcome to BlockServe - BlockChain Based Service management</u></h1>
    <div id="servicesList"></div>
    <button id="addServiceButton">Add New Service</button>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script>
        

        function handleServiceClick(name, ownerAddress, availableTill,link) {

                // Check if the user is the owner and service is available
                if ("0x5ecc6fda203598bfc8a48274ac2965859acaed4f".toLowerCase() === ownerAddress.toLowerCase()) {
                    const token = `name+${ownerAddress}`;
                        if(name=="Text-Editor" || Date.now()<availableTill || true){
                            console.log("Date "+Date.now() + " name "+name);
                    window.open(`${link}`+`?token=${token}`);}
                    
                } else {
                    alert('You do not have access to this service. Please buy it.');
                }
            }

            // Function to handle "Buy Service" button click
            async function handleBuyClick(name, ownerAddress, availableTill) {
                // Check if the service is available
                if (Date.now() < availableTill ) {
                    try {
                        // Prompt the user to initialize the transaction to buy the service
                        const result = await contract.methods.buyService().send({
                            from: web3.eth.defaultAccount,
                            value: web3.utils.toWei('0.001', 'ether')
                        });
                        alert('Service purchased successfully!');
                        fetchServices(contract);
                    } catch (error) {
                        console.error('Error buying service:', error);
                        alert('Error buying service. Please try again later.');
                    }
                } else {
                    alert('This service is no longer available.');
                }
            }


            async function fetchServices(contract) {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    console.log('Accounts:',accounts[0]);
    const fromAddress = accounts[0];
    const servicesListElement = document.getElementById('servicesList');
    servicesListElement.innerHTML = ''; 
    const services = await contract.methods.getAvailable().call();
    services.forEach((service, index) => {
        const { id, name, ownerAddress, ser_timeduration, availableTill, isFree, serviceLink } = service;

        if(ownerAddress!=0x0000000000000000000000000000000000000000){
            
        const backgroundColor = `hsl(${index * 30}, 70%, 80%)`;
        
        const listItem = document.createElement('div');
        listItem.style.backgroundColor = backgroundColor;
        listItem.style.padding = '20px';
        listItem.style.borderRadius = '10px';
        listItem.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
        listItem.style.marginBottom = '20px';
        listItem.innerHTML = `
            <p style="font-size: 18px; font-weight: bold;">Service Name: ${name}</p>
            <p style="font-size: 16px;">Owner: ${ownerAddress}</p>
            <p style="font-size: 16px;">Available Till: ${new Date(Date.now() + 86400*1000)}</p>
            <div style="display: flex; justify-content: space-between;">
                <button style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: #fff; border: none; border-radius: 5px;" onclick="handleServiceClick('${name}', '${ownerAddress}', '${availableTill}', '${serviceLink}')">Open Service</button>
                <button style="padding: 10px 20px; font-size: 16px; background-color: #28a745; color: #fff; border: none; border-radius: 5px;" onclick="handleBuyClick('${name}', '${ownerAddress}', '${availableTill}')">Buy Service</button>
            </div>
        `;
        servicesListElement.appendChild(listItem);
    }});
}



        async function handleAddServiceClick(contract) {
    try {
        // Ensure MetaMask is connected and the account is set
        await window.ethereum.enable();

        const name = prompt('Enter service name:');
        const timeduration = parseInt(prompt('Enter service duration (in seconds):'));
        console.log("Time duration you entered is ", timeduration);
        const link = prompt("Enter service link name");
        
        let servicesList = await contract.methods.getAvailable().call();
        let length = servicesList.length + 1;
        
        // Retrieve the current account from MetaMask
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        const fromAddress = accounts[0]; // Assuming the first account is used
        
        // Send the transaction with the from address specified
        const result = await contract.methods.newService(length, name, timeduration, link).send({ from: fromAddress });
        
        alert('Service added successfully!');
        
        // Reload the list of services after adding a new service
        fetchServices(contract);
    } catch (error) {
        console.error('Error adding new service:', error);
        alert('Error adding new service. Please try again later.');
    }
}


        window.addEventListener('load', async () => {
            // Connect to Web3 and initialize the contract
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
            } else if (window.web3) {
                window.web3 = new Web3(window.web3.currentProvider);
            } else {
                console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }

            const contractAbi = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timeDuration",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "serviceLink",
				"type": "string"
			}
		],
		"name": "newService",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "registerForService",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "unregister",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAvailable",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "serviceId",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "ownerAddress",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timeDuration",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "availableTill",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "isFree",
						"type": "bool"
					},
					{
						"internalType": "string",
						"name": "serviceLink",
						"type": "string"
					}
				],
				"internalType": "struct Services.Service[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "servicesList",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "serviceId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "ownerAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "timeDuration",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "availableTill",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isFree",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "serviceLink",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

            const contractAddress = '0x5fFe734D4B652be0bbA0BABD98C2CB0D21F5f6Cf';
            
            
            const contract = new web3.eth.Contract(contractAbi, contractAddress);

            
            

            

            // Get the button element
            const addServiceButton = document.getElementById('addServiceButton');

            // Add click event listener to the button
            addServiceButton.addEventListener('click', async () => {
                handleAddServiceClick(contract);
            });

            
            fetchServices(contract);
        });
    </script>
</body>
</html>
