<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Service Marketplace</title>
</head>
<body>
    <h1><u>Welcome to Cloud Service Marketplace</u></h1>
    <div id="servicesList"></div>
    <button onclick="addNewService()">Add New Service</button>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script>
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                await window.ethereum.enable();
            } else if (window.web3) {
                window.web3 = new Web3(window.web3.currentProvider);
            } else {
                console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }

            
            const contractAbi = 
            
            [
	{
		"inputs": [],
		"name": "getAvailable",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timeDuration",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "serviceLink",
				"type": "string"
			}
		],
		"name": "newService",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "registerForService",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "servicesList",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "serviceId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "ownerAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "timeDuration",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "availableTill",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isFree",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "serviceLink",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "unregister",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}


            ];

            
            const contractAddress = '0xaCd7F11be4a8577d84AA396A05E46eb41e341b2E';

            // Initialize the contract
            const contract = new web3.eth.Contract(contractAbi, contractAddress);

            // Fetch and display the list of available services
            async function fetchServices() {
                const servicesListElement = document.getElementById('servicesList');
                servicesListElement.innerHTML = ''; // Clear existing list

                const services = await contract.methods.getServices().call();
                services.forEach(service => {
                    const { name, owner, availableTill } = service;
                    const listItem = document.createElement('div');
                    listItem.innerHTML = `
                        <p>Service Name: ${name}</p>
                        <p>Owner: ${owner}</p>
                        <p>Available Till: ${new Date(availableTill * 1000)}</p>
                        <button onclick="handleServiceClick('${name}', '${owner}', ${availableTill})">Open Service</button>
                        <button onclick="handleBuyClick('${name}', '${owner}', ${availableTill})">Buy Service</button>
                    `;
                    servicesListElement.appendChild(listItem);
                });
            }

            // Function to handle "Open Service" button click
            function handleServiceClick(name, owner, availableTill) {
                // Check if the user is the owner and service is available
                if (web3.eth.defaultAccount.toLowerCase() === owner.toLowerCase() && Date.now() < availableTill * 1000) {
                    
                    window.open(`service_page.html?name=${name}&owner=${owner}`);
                } else {
                    alert('You do not have access to this service. Please buy it.');
                }
            }

            // Function to handle "Buy Service" button click
            async function handleBuyClick(name, owner, availableTill) {
                // Check if the service is available
                if (Date.now() < availableTill * 1000) {
                    try {
                        // Prompt the user to initialize the transaction to buy the service
                        const result = await contract.methods.buyService().send({
                            from: web3.eth.defaultAccount,
                            value: web3.utils.toWei('0.001', 'ether')
                        });
                        alert('Service purchased successfully!');
                        // Reload the list of services after purchase
                        fetchServices();
                    } catch (error) {
                        console.error('Error buying service:', error);
                        alert('Error buying service. Please try again later.');
                    }
                } else {
                    alert('This service is no longer available.');
                }
            }

            // Function to add a new service
            async function addNewService() {
                const name = prompt('Enter service name:');
                const timeduration = prompt('Enter service duration (in seconds):');
                try {
                    // Call the contract method to add a new service
                    const result = await contract.methods.newService(name, timeduration).send({ from: web3.eth.defaultAccount });
                    alert('Service added successfully!');
                    // Reload the list of services after adding a new service
                    fetchServices();
                } catch (error) {
                    console.error('Error adding new service:', error);
                    alert('Error adding new service. Please try again later.');
                }
            }

            // Fetch services when the page loads
            fetchServices();
        });
    </script>
</body>
</html>
